<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Nugget Finder - Implementation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007cba;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #005a8b;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .nugget {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        .nugget-type {
            font-weight: bold;
            color: #007cba;
            text-transform: uppercase;
            font-size: 12px;
        }
        .nugget-content {
            margin: 5px 0;
            font-style: italic;
        }
        .nugget-synthesis {
            color: #666;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            color: #666;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.testing {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status.valid {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.invalid {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Golden Nugget Finder - Implementation Test</h1>
        <p>This page tests the current Gemini API implementation without using the official SDK.</p>

        <div class="form-group">
            <label for="apiKey">Gemini API Key:</label>
            <input type="text" id="apiKey" placeholder="Enter your Gemini API key">
            <button onclick="testApiKey()">Test API Key</button>
            <div id="apiKeyStatus"></div>
        </div>

        <div class="form-group">
            <label for="testContent">Test Content:</label>
            <textarea id="testContent" placeholder="Enter content to analyze...">This is a test article about artificial intelligence. 

AI has revolutionized how we approach problem-solving. One interesting tool is the use of analogies to explain complex concepts. For example, neural networks can be thought of as interconnected neurons in a brain, where each connection has a weight that determines how much influence one neuron has on another.

The key insight is that this biological metaphor helps us understand how information flows through the system. When we train a neural network, we're essentially adjusting these weights to make the system better at pattern recognition.

From first principles, this is really about optimization - finding the best set of parameters that minimize prediction error. It's a beautiful example of how mathematical optimization principles apply to real-world problems.</textarea>
        </div>

        <div class="form-group">
            <label for="testPrompt">Test Prompt:</label>
            <textarea id="testPrompt" placeholder="Enter analysis prompt...">Extract golden nuggets that would be valuable for a pragmatic synthesizer with ADHD. Focus on actionable insights, elegant principles, tools, analogies, and explanations that connect to first principles thinking. Prioritize content that answers "how things work" or provides practical synthesis.</textarea>
        </div>

        <button onclick="testAnalysis()">Test Analysis</button>

        <div id="result"></div>
    </div>

    <script>
        const GEMINI_CONFIG = {
            MODEL: 'gemini-2.5-flash',
            THINKING_BUDGET: -1
        };

        const GOLDEN_NUGGET_SCHEMA = {
            type: "object",
            properties: {
                golden_nuggets: {
                    type: "array",
                    description: "An array of extracted golden nuggets.",
                    minItems: 0,
                    items: {
                        type: "object",
                        properties: {
                            type: {
                                type: "string",
                                description: "The category of the extracted golden nugget.",
                                enum: ["tool", "media", "explanation", "analogy", "model"]
                            },
                            content: {
                                type: "string",
                                description: "The original comment(s) verbatim, without any changes to wording or symbols."
                            },
                            synthesis: {
                                type: "string",
                                description: "A concise explanation of why this is relevant to the persona, connecting it to their core interests or cognitive profile."
                            }
                        },
                        required: ["type", "content", "synthesis"]
                    }
                }
            },
            required: ["golden_nuggets"]
        };

        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const statusDiv = document.getElementById('apiKeyStatus');
            
            if (!apiKey) {
                statusDiv.innerHTML = '<div class="status invalid">Please enter an API key</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="status testing">Testing API key...</div>';

            try {
                const isValid = await validateApiKey(apiKey);
                
                if (isValid) {
                    statusDiv.innerHTML = '<div class="status valid">✓ API key is valid</div>';
                } else {
                    statusDiv.innerHTML = '<div class="status invalid">✗ API key is invalid</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status invalid">✗ Error testing API key: ' + error.message + '</div>';
            }
        }

        async function validateApiKey(apiKey) {
            const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
            
            const testRequestBody = {
                contents: [{
                    parts: [{ text: "Test message" }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "object",
                        properties: {
                            test: {
                                type: "string"
                            }
                        },
                        required: ["test"]
                    }
                }
            };

            const response = await fetch(`${API_BASE_URL}/${GEMINI_CONFIG.MODEL}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testRequestBody)
            });

            return response.ok;
        }

        async function testAnalysis() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const content = document.getElementById('testContent').value.trim();
            const prompt = document.getElementById('testPrompt').value.trim();
            const resultDiv = document.getElementById('result');

            if (!apiKey) {
                resultDiv.innerHTML = '<div class="result error">Please enter an API key first</div>';
                return;
            }

            if (!content || !prompt) {
                resultDiv.innerHTML = '<div class="result error">Please enter both content and prompt</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">Analyzing content...</div>';

            try {
                const result = await analyzeContent(apiKey, content, prompt);
                displayResults(result);
            } catch (error) {
                resultDiv.innerHTML = '<div class="result error">Analysis failed: ' + error.message + '</div>';
            }
        }

        async function analyzeContent(apiKey, content, userPrompt) {
            const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models';
            
            const fullPrompt = `${content}\n\n${userPrompt}`;
            
            const requestBody = {
                contents: [{
                    parts: [{ text: fullPrompt }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: GOLDEN_NUGGET_SCHEMA,
                    thinkingConfig: {
                        thinkingBudget: GEMINI_CONFIG.THINKING_BUDGET
                    }
                }
            };

            const response = await fetch(`${API_BASE_URL}/${GEMINI_CONFIG.MODEL}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Gemini API error: ${response.status} ${response.statusText} - ${errorText}`);
            }

            const responseData = await response.json();
            
            // Extract the text from the response
            const responseText = responseData.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!responseText) {
                throw new Error('No response text received from Gemini API');
            }

            const result = JSON.parse(responseText);
            
            // Validate the response structure
            if (!result.golden_nuggets || !Array.isArray(result.golden_nuggets)) {
                throw new Error('Invalid response format from Gemini API');
            }

            return result;
        }

        function displayResults(result) {
            const resultDiv = document.getElementById('result');
            const nuggets = result.golden_nuggets;

            if (nuggets.length === 0) {
                resultDiv.innerHTML = '<div class="result success">Analysis complete. No golden nuggets were found.</div>';
                return;
            }

            let html = '<div class="result success">';
            html += `<h3>Found ${nuggets.length} Golden Nuggets:</h3>`;
            
            nuggets.forEach((nugget, index) => {
                html += `
                    <div class="nugget">
                        <div class="nugget-type">[${nugget.type}]</div>
                        <div class="nugget-content">"${nugget.content}"</div>
                        <div class="nugget-synthesis"><strong>Why it matters:</strong> ${nugget.synthesis}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>